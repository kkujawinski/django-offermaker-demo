{% extends "offermaker.html" %}

{% block BODY %}

{% verbatim %}

    <article class="markdown-body entry-content" itemprop="mainContentOfPage"><h1>
<a id="user-content-offer-maker" class="anchor" href="#offer-maker" aria-hidden="true"><span class="octicon octicon-link"></span></a>Offer Maker</h1>
<h2>
<a id="user-content-changelog" class="anchor" href="#changelog" aria-hidden="true"><span class="octicon octicon-link"></span></a>Changelog</h2>
<ul>
<li>
<p>0.9.5</p>
<blockquote>
<ol>
<li>Small bug fixes</li>
</ol>
</blockquote>
</li>
<li>
<p>0.9.4</p>
<blockquote>
<ol>
<li>Django 1.7 support</li>
<li>Python 3 support</li>
</ol>
</blockquote>
</li>
</ul>
<h2>
<a id="user-content-demo-application" class="anchor" href="#demo-application" aria-hidden="true"><span class="octicon octicon-link"></span></a>Demo application</h2>
<ol>
<li>
<p>You can check it online <a href="http://offermaker.kjw.pt">http://offermaker.kjw.pt</a></p>
</li>
<li>
<p>Or checkout and install locally:</p>
<pre>
git clone git@github.com:kkujawinski/django-offermaker-demo.git
</pre>
</li>
</ol>
<h2>
<a id="user-content-quick-start" class="anchor" href="#quick-start" aria-hidden="true"><span class="octicon octicon-link"></span></a>Quick start</h2>
<ol>
<li>
<p>Install django-offermaker</p>
<pre>
pip install django-offermaker
</pre>
</li>
<li>
<p>Site configuration in settings.py</p>
<pre>
INSTALLED_APPS = (
    ...
    'offermaker',
)
</pre>
</li>
<li>
<p>Create Django form:</p>
<pre>
from django import forms

class MyForm(forms.Form):
    product = forms.ChoiceField(
        label=u'Product',
        choices=(
            ('', '---'), ('PROD1', 'Product X'), ('PROD2', 'Product Y'), ('PROD3', 'Product Z'),
        ),
        required=False)
    crediting_period = forms.ChoiceField(
        label=u'Crediting period',
        choices=(('', '---'), ('12', '12'), ('24', '24'), ('36', '36'), ('48', '48')))
    interest_rate = forms.FloatField(label=u'Interest rate', min_value=1, max_value=5)
    contribution = forms.FloatField(label=u'Contribution', min_value=0)
</pre>
</li>
<li>
<p>Define your offer (in case you do not store it in database):</p>
<pre>
offer = {
    'variants': [
        [{
            'params': {'product': 'PROD1', 'crediting_period': ['24']},
        }, {
            'params': {'product': 'PROD2'},
            'variants': [
                {'params': {'crediting_period': ['12']}},
                {'params': {'crediting_period': ['36']}},
                {'params': {'crediting_period': ['48']}}]
        }, {
            'params': {'product': 'PROD3'},
        }],
        [{
            'params': {'product': 'PROD1'},
            'variants': [
                {'params': {'contribution': (10, 20), 'interest_rate': (2, 2)}},
                {'params': {'contribution': (30, 40), 'interest_rate': (4, 4)}}]
        }, {
            'params': {'product': ['PROD2', 'PROD3']},
            'variants': [{
                'params': {'contribution': (30, 70), 'interest_rate': (5, 5)}
            }]
        }]
    ]
}
</pre>
</li>
<li>
<p>Offer form:</p>
</li>
</ol>
<ol>
<li>
<p>Use dispatcher code in Django view</p>
<pre>
import offermaker

class MyOfferFormView(offermaker.OfferMakerFormView):
    form_class = MyForm
    offermaker_offer = offer
    template_name = 'my_offer_form_view.html'

my_offer_form_view = MyOfferFormView.as_view()
</pre>
</li>
<li>
<p>Initialize offerform in template</p>
<pre>
&lt;head&gt;
{% load offermaker %}
&lt;script type="text/javascript" src="http://code.jquery.com/jquery-1.10.2.min.js"&gt;&lt;/script&gt;
{% offermaker_javascript %}
&lt;/head&gt;

&lt;body&gt;

&lt;form action="?" method="post" id="offer_form"&gt;
    &lt;div class="alert-placeholder" style="height: 30px;"&gt;&lt;/div&gt;
    {% csrf_token %}
    {{ form.as_p }}
    &lt;button type="submit"&gt;Submit&lt;/button&gt;
&lt;/form&gt;


&lt;script type="text/javascript"&gt;
    (function() {
        $('#offer_form').offer_form();
    })();
&lt;/script&gt;
</pre>
</li>
</ol>
<ol start="6">
<li>Offer preview:</li>
</ol>
<ol>
<li>
<p>Pass offerform object from view to template:</p>
<pre>
def my_form_view(request):
    core_object = offermaker.OfferMakerCore(MyForm, offer)
</pre>
</li>
<li>
<p>Use proper template tag in template to print table:</p>
<pre>
{% load offermaker %}

{% offermaker_preview offer %}
</pre>
</li>
</ol>
<ol start="7">
<li>Offer editor:</li>
</ol>
<ol>
<li>
<p>Use OfferJSONField field in your model. Remember to pass your django form created in 3.:</p>
<pre>
import offermaker

class MyOffer(models.Model):
    id = models.AutoField(primary_key=True)
    name = models.CharField(max_length=30)
    offer = offermaker.OfferJSONField(form_object=MyForm())
</pre>
</li>
<li>
<p>Create your own Admin Site for model:</p>
<pre>
import models

class OfferAdmin(admin.ModelAdmin):
    list_display = ('name',)
    search_fields = ('name', 'user')
    fields = ('name', 'offer')

admin.site.register(models.Offer, OfferAdmin)
</pre>
</li>
</ol>
<ol start="7">
<li>
<p>Decision-making tool:</p>
<pre>
core_object = offermaker.OfferMakerCore(MyForm, offer)

result = core_object.decide({'crediting_period': 24})
print(result['product'].items)  # frozenset({'PROD1', 'PROD3'})
print(result['interest_rate'].ranges)  # frozenset({(4, 4), (5, 5), (2, 2)})
print(result['contribution'].ranges)  # frozenset({(10, 20), (30, 70)})

result = core_object.decide({'crediting_period': 24, 'interest_rate': 2})
print(result['product'].fixed)  # PROD1
</pre>
</li>
</ol>
<h2>
<a id="user-content-basic-customization" class="anchor" href="#basic-customization" aria-hidden="true"><span class="octicon octicon-link"></span></a>Basic customization</h2>
<ol>
<li>Using offers stored in database:</li>
</ol>
<ol>
<li>
<p>you need to pass proper offer object to Offermaker in form/preview view:</p>
<pre>
offer = MyOffer.objects.filter(id=request.GET['id']).first()
core_object = offermaker.OfferMakerCore(MyForm, offer.offer)
</pre>
</li>
<li>
<p>and configure proper params to be used ajax requests:</p>
<pre>
$('#offer_form').offer_form({
    ajax_extra_params: function(params) {
        return { id: {{ request.GET.id }} };
    },
});
</pre>
</li>
</ol>
<ol start="2">
<li>
<p>Substituting builtin formatters for infotip and error alerts:</p>
<pre>
$('#offer_form').offer_form({
    error_alert_factory: function (msg) {
        var $error = $('&lt;p class="error"&gt;&lt;span&gt;' + msg + '&lt;/span&gt;&lt;/p&gt;');
        $('.alert-placeholder', $form).append($error);
        return $error;
    },
    tooltip_factory: function ($field, msg) {
        var $tooltip = $('&lt;p class="infotip"&gt;' + msg + '&lt;/p&gt;');
        $field.parent().append($tooltip);
        return $tooltip;
    }
});
</pre>
</li>
<li>
<p>Use builtin formatters for Twitter Bootstap3:</p>
<pre>
(function() {
    $('#offer_form').offer_form({
        bootstrap3: true,
    });
})();
</pre>
</li>
<li>
<p>Customizing messages:</p>
<pre>
(function() {
    $('#offer_form').offer_form({
        msgs: {
            'NO_VARIANTS': 'No matching variants',
            'INFO_ITEMS': 'Available values are: %s.',
            'INFO_FIXED': 'Only available value is %s.',
            'RANGE_left': 'to %2$s',
            'RANGE_right': 'from %1$s',
            'RANGE_both': 'from %1$s to %2$s',
            'AND': ' and '
        },
        iteration_str: function (items) {
            return items.slice(0, -2).concat(items.slice(-2).join(msgs.AND)).join(', ');
        }
    });
})();
</pre>
</li>
<li>
<p>Creating preview table for certain fields:</p>
<pre>
{% offermaker_preview offer fields='product, crediting_period' %}
</pre>
</li>
<li>
<p>Add html attributes to generated preview table:</p>
<pre>
{% offermaker_preview offer class='table table-bordered' %}
</pre>
</li>
</ol>
<h2>
<a id="user-content-troubleshooting" class="anchor" href="#troubleshooting" aria-hidden="true"><span class="octicon octicon-link"></span></a>Troubleshooting</h2>
<ol>
<li>I run Django 1.5 and I have jQuery older than 1.9.</li>
</ol>
<p>You need to add new jQuery library dependency in you django admin site:</p>
<pre>
class OfferAdmin(admin.ModelAdmin):
    ...
    class Media:
        js = ('//code.jquery.com/jquery-1.11.0.min.js',)
</pre>
<ol start="2">
<li>I run Django 1.5 and django-offermaker doesn't recognize field types properly.</li>
</ol>
<p>Django 1.5 admin site is not using HTML5 input types (ex. number), you can give hint
to django-offermaker about field type with following code:</p>
<pre>
def __init__(self, *args, **kwargs):
    super(MyForm, self).__init__(*args, **kwargs)
    self.fields['interest_rate'].widget.attrs['data-om-type'] = 'number'
    self.fields['interest_rate'].widget.attrs['data-om-min'] = 1
    self.fields['interest_rate'].widget.attrs['data-om-max'] = 5
    self.fields['contribution'].widget.attrs['data-om-type'] = 'number'
    self.fields['contribution'].widget.attrs['data-om-min'] = 0
</pre>

</article>
{% endverbatim %}

{% endblock %}